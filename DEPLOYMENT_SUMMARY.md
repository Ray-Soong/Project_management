# DSM 服务器部署方案总结

## 部署架构

本项目管理系统采用容器化部署方案，适配群晖 DSM 7.x 系统。

### 核心组件

1. **Web 应用层**
   - Flask 应用 (Python 3.10)
   - Gunicorn WSGI 服务器
   - 4个工作进程，支持并发访问

2. **数据存储层**
   - PostgreSQL 14 主数据库
   - Redis 7 缓存/会话存储

3. **反向代理层**
   - Nginx Alpine 版本
   - SSL/TLS 终止
   - 静态文件服务
   - 负载均衡

4. **监控层 (可选)**
   - Prometheus 指标收集
   - Grafana 可视化仪表板
   - ELK Stack 日志聚合

## 部署文件清单

### 核心部署文件
- `Dockerfile` - 应用容器构建文件
- `docker-compose.yml` - 主服务编排
- `docker-compose.monitoring.yml` - 监控服务编排
- `wsgi.py` - WSGI 入口文件
- `config_prod.py` - 生产环境配置

### 配置文件
- `nginx/nginx.conf` - Nginx 反向代理配置
- `monitoring/prometheus.yml` - Prometheus 监控配置
- `init.sql` - 数据库初始化脚本
- `requirements-prod.txt` - 生产环境依赖

### 部署脚本
- `deploy-dsm.sh` - 自动化部署脚本
- `DSM_DEPLOYMENT_GUIDE.md` - 详细部署指南

## 关键特性

### 安全性
- SSL/TLS 加密传输
- 自签名证书 (可替换为有效证书)
- 安全 HTTP 头配置
- 密码哈希存储
- CSRF 保护

### 可扩展性
- 容器化架构，易于水平扩展
- 数据库连接池
- Redis 缓存提升性能
- 负载均衡支持

### 可维护性
- 统一日志收集
- 健康检查端点
- 自动化备份脚本
- 系统监控告警

### 高可用性
- 容器自动重启
- 数据持久化存储
- 服务健康检查
- 优雅停机处理

## 部署流程

### 自动部署 (推荐)
```bash
chmod +x deploy-dsm.sh
./deploy-dsm.sh
```

### 手动部署
1. 创建目录结构
2. 生成 SSL 证书
3. 配置环境变量
4. 启动 Docker 服务
5. 验证部署结果

## 运维管理

### 服务管理
- systemctl 服务控制
- docker-compose 容器管理
- 自动备份策略
- 日志轮转配置

### 监控告警
- 应用性能监控
- 系统资源监控
- 数据库性能监控
- 日志异常检测

### 备份恢复
- 数据库定时备份
- 应用数据备份
- 一键恢复脚本
- 灾难恢复计划

## 访问信息

### 应用访问
- **主应用**: https://your-dsm-ip
- **管理界面**: 内置于主应用

### 监控访问 (可选)
- **Grafana**: http://your-dsm-ip:3000
- **Prometheus**: http://your-dsm-ip:9090
- **Kibana**: http://your-dsm-ip:5601

### 默认账户
- **管理员**: admin / (查看 .env 文件)
- **开发者**: developer / (查看 .env 文件)

## 性能优化

### 应用层优化
- Gunicorn 多进程
- 数据库连接池
- Redis 缓存
- 静态文件 CDN

### 数据库优化
- 索引优化
- 查询优化
- 连接池配置
- 定期维护

### 系统层优化
- 内存分配
- 磁盘 I/O 优化
- 网络配置
- 容器资源限制

## 安全建议

### 生产环境安全
1. 更换默认密码
2. 配置有效 SSL 证书
3. 设置防火墙规则
4. 启用访问日志审计
5. 定期安全更新

### 网络安全
1. 限制管理端口访问
2. 配置 VPN 访问
3. 启用入侵检测
4. 定期漏洞扫描

## 故障排除

### 常见问题
1. 容器启动失败 → 检查端口占用和配置
2. 数据库连接失败 → 验证网络和认证
3. SSL 证书问题 → 检查证书文件和权限
4. 性能问题 → 查看监控指标和日志

### 调试工具
- Docker 日志查看
- 应用健康检查
- 数据库连接测试
- 网络连通性检查

## 维护计划

### 日常维护
- 监控系统状态
- 检查备份完整性
- 清理日志文件
- 更新安全补丁

### 定期维护
- 数据库优化
- 容器镜像更新
- 安全审计
- 性能调优

### 年度维护
- SSL 证书更新
- 硬件升级评估
- 灾难恢复演练
- 架构优化评估

## 技术支持

如需技术支持，请提供：
1. 系统版本信息
2. 错误日志详情
3. 问题复现步骤
4. 环境配置信息

---

此部署方案已在群晖 DSM 7.x 环境中测试验证，可用于生产环境部署。